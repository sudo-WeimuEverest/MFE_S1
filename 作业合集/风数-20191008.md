课程名称：《风险管理的数学方法》
提交日期：2019年10月8日
姓名：胡庆涛
学号：1901210003

## 1、VaR及其工具的计算

> 假定某投资组合由两种外国货币：加拿大元（CAD）和欧元（EUR）构成，两种货币不相关，并且相对于美元分别有 $5\%$ 和 $12\%$ 的波动性，分别对其投资 200万美元和 100万美元，置信水平为 $95\%$ 。假如中途追加投资10万美元加拿大元。 

- **计算$VaR$**

  记 $x$ 为对两种货币的投资金额，以下运算以百万美元为单位，投资组合的方差为：
  $$
  x^{\prime} \sum x=(2\quad1)\left(\begin{array}{cc}{0.05^{2}} & {0} \\ {0} & {0.12^{2}}\end{array}\right)\left(\begin{array}{l}{2} \\ {1}\end{array}\right)=(2\quad1)\left(\begin{array}{l}{0.0050} \\ {0.0144}\end{array}\right)=0.0244
  $$
  因此组合的 $VaR$ 为（单位以美元记）：
  $$
  VaR_{p}=\Phi^{-1}(\alpha)\sigma_{p}W=\Phi^{-1}(\alpha)\sqrt{x^{\prime} \sum x}=1.65 \times \sqrt{0.0244} \times 1000000=257738
  $$
  两种货币分别对应的 $VaR$ 为：
  $$
  \left(\begin{array}{c}{VaR_{1}} \\ {Va R_{2}}\end{array}\right)=\left(\begin{array}{c}{\Phi^{-1}(\alpha)\sigma_{1}W_{1}} \\ {\Phi^{-1}(\alpha)\sigma_{2}W_{2}}\end{array}\right)=\left(\begin{array}{c}{1.65 \times 0.05 \times 2000000} \\ {1.65 \times 0.12 \times 1000000}\end{array}\right)=\left(\begin{array}{c}{165000} \\ {198000}\end{array}\right)
  $$

- **计算边际$VaR$**
  $$
  \Delta VaR_{i}=\frac{\partial VaR}{\partial x_{i}}=\Phi^{-1}(\alpha) \frac{\operatorname{cov}\left(R_{i}, R_{p}\right)}{\sigma_{p}}
  $$
  而又有，$\beta=\frac{\sum w}{w^{\prime} \sum w}$，故得：$\Delta Va R_{i}=\frac{V a R}{W} \beta_{i}$

  在该例中有
  $$
  \beta=W \times \frac{\sum x}{x^{\prime} \sum x}=3 \times\left(\begin{array}{cc}{0.05^{2}} & {0} \\ {0} & {0.12^{2}}\end{array}\right)\left(\begin{array}{l}{2}\\{1}\end{array}\right)/ 0.0244=\left(\begin{array}{c}{0.615} \\ {1.770}\end{array}\right)
  $$
  故边际 $VaR$ 为：
  $$
  \Delta VaR=\Phi^{-1}(\alpha)\left(\frac{\operatorname{cov}\left(R_{1}, R_{p}\right)}{\sigma_{p}}, \frac{\operatorname{cov}\left(R_{2}, R_{p}\right)}{\sigma_{p}}\right)^{\prime}=\left(\begin{array}{c}{0.0528} \\ {0.1521}\end{array}\right)
  $$

- **计算增量 $VaR$** 

  近似计算可得（单位为美元）：
  $$
  \Delta V a R^{\prime} \times a=\left(\begin{array}{cc}{0.0528} & {0.1521}\end{array}\right)\left(\begin{array}{c}{100000} \\ {0}\end{array}\right)=5280
  $$
  而又有新的组合方差为：
  $$
  \sigma_{p+a}^{2} W_{p+a}^{2}=(2.10\quad1)\left(\begin{array}{cc}{0.05^{2}} & {0} \\ {0} & {0.12^{2}}\end{array}\right)\left(\begin{array}{c}{2.10} \\ {1}\end{array}\right)= 0.1592
  $$
  新组合的 $VaR$ 为：
  $$
  VaR_{p+a}=\Phi^{-1}(\alpha)\sigma_{p+a}W_{p+a}=1.65 \times \sqrt{0.1592} \times 1000000=262350
  $$
  真实的增量 $VaR$ 为：
  $$
  VaR_{p+a}-VaR_{p}= 4612
  $$

- **计算成分 $VaR$** 
  $$
  C VaR_{i}=\left(\Delta VaR_{i}\right) x_{i}
  $$
  加拿大元和欧元的成分 $VaR$ 为：
  $$
  \begin{aligned} &\left(\begin{array}{c}{C V a R_{1}} \\ {C V a R_{2}}\end{array}\right)=\left(\begin{array}{c}{0.0528 \times 2000000} \\ {0.1521 \times 1000000}\end{array}\right) =\left(\begin{array}{c}{105630} \\ {152108}\end{array}\right)=\operatorname{VaR}\left(\begin{array}{c}{41.0 \%} \\ {59.0 \%}\end{array}\right) \end{aligned}
  $$
  故有：
  $$
  \begin{aligned} &\left(\begin{array}{c}{C V a R_{1} / V a R} \\ {C V a R_{2} / V a R}\end{array}\right)=\left(\begin{array}{c}{w_{1} \beta_{1}} \\ {w_{2} \beta_{2}}\end{array}\right) =\left(\begin{array}{c}{0.667 \times 0.615} \\ {0.333 \times 1.770}\end{array}\right)=\left(\begin{array}{c}{41.0 \%} \\ {59.0 \%}\end{array}\right) \end{aligned}
  $$
  

## 2、计算每只股票的VaR及组合VaR

> 选取10只股票，分别为：贵州茅台、华兰生物、复星医药、万科A、招商银行、宁沪高速、中国平安、新城控股、春秋航空、福成股份。
>
> 运用$Delta-Normal$ 方法求股票的 $VaR$,  股票历史时间选取 "2018-09-01 ~ 2019-09-01 "，实际交易日共242天。各只股票投资权重，依据其市值的比例确定。

代码如下：

```python
import numpy as np
import pandas as pd
from scipy.stats import norm 

class Stock: #定义股票class,调用时可直接返回对应的收益率、方差以及VaR
    def __init__(self,price):
        self.price = price
        log_price = np.log(price)
        self.log_return = np.diff(log_price)
    def get_return(self):
        self.returns = np.mean(self.log_return)
        return self.returns
    def get_var(self):
        self.var = np.var(self.log_return)
        return self.var
    def get_VaR(self,a,total,weight): #计算单只股票的VaR
        self.VaR = norm.ppf(a) * np.std(self.log_return)*total*weight 
        return self.VaR

#直接输出每只股票的VaR(by Delta-Normal)
def ind_VaR(P,W): #输入值分别为股票的价格数据和投资权重数据
    columns = P.columns.values.tolist() #获取股票价格数据的列名，即股票的名称
    for name in columns: 
        stock = Stock(P[name])
        weight = W.loc[name,'weight'] #W为储存股票投资权重的矩阵
        ind_VaR = stock.get_VaR(a,total,weight)
        ind_VaR = round(ind_VaR,4) #小数点保留到四位数
        print('%s的VaR为%s' % (name,ind_VaR))

#求股票之间的协方差矩阵后，求出投资组合的VaR
def por_VaR(P,W):
    #求股票收益率的协方差矩阵
    columns = P.columns.values.tolist() #获取股票价格数据的列名，即股票的名称
    R = pd.DataFrame()
    for name in columns: 
        stock = Stock(P[name])
        R[name] = stock.log_return #储存一个对数收益率的dataframe
    Sigma = R.cov()
    Sigma = Sigma.values #求得投资组合的协方差矩阵

    Weight = W.values #将权重向量转化为数组
    W_T = Weight.reshape(1,len(Weight)) #一维向量转置后以备相乘
    W_A = Weight.reshape(len(Weight),1)
    B = np.dot(Sigma, W_A)
    var = np.dot(W_T, B) #计算得到投资组合的方差
    por_VaR = norm.ppf(a) * np.sqrt(var[0][0]) * total#计算投资组合的VaR
    por_VaR = round(por_VaR,4)
    return por_VaR

if __name__=="__main__":
    a = 0.95 #设定计算VaR的置信水平
    total = 1000000 #设定总投资金额
    P = pd.read_excel('C://Users//Lenovo//Desktop//stocks.xlsx',sheet_name=0)#读取股票价格数据
    W = pd.read_excel('C://Users//Lenovo//Desktop//stocks.xlsx',sheet_name=1,index_col='name') #读取股票投资权重数据
    W_weight = W.drop(W.columns[0],1)
    P_price = P.drop('date',1)
    ind_VaR(P_price,W)
    por_VaR = por_VaR(P_price,W_weight)
    print('该投资组合的VaR为%s' % por_VaR)
```

将各项参数输入为： a = 0.95; total = 1000000。程序运行返回结果如下：

```
贵州茅台的VaR为15363.8424
华兰生物的VaR为681.4024
万科A的VaR为2584.5473
招商银行的VaR为6084.8109
宁沪高速的VaR为206.8177
中国平安的VaR为8463.1035
新城控股的VaR为846.418
春秋航空的VaR为374.6703
福成股份的VaR为55.5332
该投资组合的VaR为30462.6635
```

